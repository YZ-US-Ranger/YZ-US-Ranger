Useful references:
https://cran.r-project.org/web/views/Survival.html


Instead of calling this course “Survival analysis in R”, we should actually have called it “Time-to-event data analysis in R” because we will discuss methods where the event does not have to be death. The reason why we still called it “Survival analysis in R” is because this is the most commonly used term.

We will discuss duration times. Usually, we are interested in a certain event (for example, death) and want to know the time until this event happens. The event of interest can be very diverse, but we are always interested in the time until this event occurs.

```
# Check out the help page for this dataset
help(GBSG2, package = "TH.data")

# Load the data
data(GBSG2, package = "TH.data")

# Look at the summary of the dataset
summary(GBSG2)
```

Why do we need special methods for time-to-event data? Why can’t I just compute a linear model?

1.Duration times are always positive.

So we need to work with distributions that can handle positive outcomes. The linear model, for example, assumes a normal distribution, which is not very appropriate for positive outcomes. A common distribution to model duration times is the Weibull distribution and the corresponding model is called the Weibull model.

2.Different measures are of interest.

Historically in survival analysis, the survivor function or the survival curve has been a measure of interest. 
Usually, in regression, we think about densities and distribution functions.
The reason for the popularity of the survivor function is that it essentially answers the main questions in survival analysis. For example,
What is the probability that a breast cancer patient survives longer than 5 years?
What is the typical waiting time for a cab?
Out of 100 unemployed people, how many do we expect to have a job again after 2 months?

3.Censoring (probably the most important)

the most common type of censoring in survival analysis: right censoring. 

The `cens` variable contains values that indicate whether or not a person in the study has died.
The convention is that the censoring indicator is 1 if the event of interest happened.
`cens` = 1 means the person died during the study period.

```
# Count censored and uncensored data
num_cens <- table(GBSG2$cens)
num_cens

# Create barplot of censored and uncensored data
barplot(num_cens)
```

Using the `Surv()` function (which generates a `Surv` object.) for GBSG2

```
# Create Surv-Object
library("survival")
sobj <- Surv(GBSG2$time, GBSG2$cens)

# Look at 10 first elements
sobj[1:10]

# Look at summary
summary(sobj)

# Look at structure
str(sobj)
```

The `Surv` object allows us to specify that time and cens belong together. Notice that the elements of the object have a `+` symbol if they are censored observations.

## Survival function
Theory: S(t)=1−F(t)=P(T>t)
We denote the survival function here by capital S and the cumulative distribution function by capital F.

In the survival context, the survival function gives the probability to survive beyond a time point, small t.
The survival function is just 1 minus the cumulative distribution function.
The survival function is a function over time and for any point in time you can say how probable it is to survive longer than that point in time.

Graph: []

Interpretation 1: Probability that duration is longer than t.

Interpretation 2: We can also look at the survival function from the other direction, by fixing a certain quantile. Most popular is looking at the median. (The median is the 50%-Quantile.)
The median duration is t. 
Examples:
The median survival time is 3.7 years.
Median time until the cab arrives is 3.7 minutes.

Graph: []

Examples:
Probability to survive beyond time point t.
Probability that the cab takes more than t minutes to arrive.

Interpretation 3: The survival curve also gives us the percentage of durations taking longer than t.
100 ⋅ S^(t) percent of durations are longer than t.
Examples:
37 percent of all patients survive longer than 4 years. 63 percent die within the first 4 years.
Out of 100 cabs, 37 take more than 4 minutes to arrive.

## How to estimate the survival function using the Kaplan-Meier estimation
Formula: [] which tells us to take the product of this stuff here for all previous time points. And we only need to look at time points where something happens.
n_i denotes the number of individuals under observtion at time point t_i;
d_i denotes the number of individuals dying at t_i.

You might already know estimators for the cumulative distribution function and wonder: 
Why don't we just use that and take one minus this estimator to receive an estimator for the survival function?
This could, in fact, be done if there is no censoring or the estimator is able to deal with censoring, which is usually not the case.
Kaplan-Meier curves allow for this.

Compare the curve with the data: []
We see that the survival probability is 1 until the first event occurs at time point 4.
There it drops quite a bit because two events happen (two people die).
At time point 5 there is another smaller drop.
Note that there is no drop at time points where we have censoring, for example, time point 2.
Note also that we use these marks to visualize the time points of censoring.
At time point 2, we have 5 individuals under observation, one of them is censored at time point 2 but none die. Note that we do not need to take a product here because all time points before have a value of 1 and 1 times x is the same as x.
At time point 3 nobody dies, so the survival probability stays 1, but note how the number of individuals under observation has gone down from 5 to 4 due to the censoring of one individual.
At time point 4 two people die.
At time point 5 we need to take the previous value 1/2 times the new value.
At time point 6 nothing changes because there are no deaths.

Key take-away: It only drops when a patient dies.

We can compute the same thing in R using the survfit function.

```
km <- survfit(Surv(time, event) ~ 1)
# The 1 behind the tilde shows that we want to compute one survival function for all observations.

ggsurvplot(km, conf.int = FALSE, risk.table = "nrisk_cumevents", legend = "none")
# To reproduce the plot that we have been looking at, use the ggsurvplot() function.
# The first argument is the Kaplan-Meier estimate.
# The conf.int argument signifies if you want a confidence interval, which we don't.
# risk.table = "nrisk_cumevents" signifies that we would like to see a table with the number of individuals under observation and the sum of events in brackets.
# We need no legend because we have only one curve of all patients, so we set legend = "none".
```

```
# Create time and event data
time <- c(5, 6, 2, 4, 4)
event <- c(1, 0, 0, 1, 1)

# Compute Kaplan-Meier estimate
km <- survfit(Surv(time, event) ~ 1)
km

# Take a look at the structure
str(km)

# Create data.frame
data.frame(time = km$time, n.risk = km$n.risk, n.event = km$n.event,
  n.censor = km$n.censor, surv =km$surv)
```
